<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documenta√ß√£o T√©cnica - Dash Alertas</title>
    <style>
        :root {
            --bg-color: #1a1c2f;
            --card-color: #2c2f48;
            --text-color: #f0f0f0;
            --text-secondary-color: #a0a0b0;
            --border-color: #404466;
            --accent-color: #4e73df;
            --success-color: #1cc88a;
            --warning-color: #d2c83b;
            --danger-color: #e74a3b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            font-weight: 600;
            color: var(--accent-color);
            font-size: 1.1em;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }
        h1, h2, h3, h4 {
            color: var(--text-color);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        h1 { font-size: 1.8em; margin-bottom: 20px; }
        h2 { font-size: 1.8em; margin-top: 50px; }
        h3 { font-size: 1.4em; margin-top: 40px; border-bottom-style: dashed; }
        h4 { font-size: 1.1em; margin-top: 30px; border-bottom: none; color: var(--accent-color); }
        p { color: var(--text-secondary-color); }
        a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }
        code {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.9em;
            color: var(--warning-color);
        }
        pre {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }
        pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--text-secondary-color);
        }
        .card {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
        }
        ul, ol {
            padding-left: 20px;
            color: var(--text-secondary-color);
        }
        li { margin-bottom: 10px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background-color: #262940;
            font-weight: bold;
            text-align: center;
        }
        td {
            background-color: #33365a;
        }
        td:first-child {
            font-weight: 500;
            color: var(--text-color);
        }
        td:nth-child(2) { text-align: center; }
        .flow-diagram {
            display: flex;
            justify-content: space-around;
            list-style: none;
            padding: 0;
            text-align: center;
            gap: 15px;
        }
        .flow-diagram .flow-step {
            flex: 1;
            padding: 10px;
            position: relative;
            min-width: 0; /* Prevent flex items from overflowing */
        }
        .flow-diagram .flow-step:not(:last-child)::after {
            content: '‚Üí';
            position: absolute;
            right: -12px;
            top: 40%;
            transform: translateY(-50%);
            font-size: 2em;
            color: var(--accent-color);
        }
        .flow-diagram .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
        }
        .flow-diagram h4 {
            font-size: 1em;
            margin-bottom: 5px;
            border: none;
            padding-bottom: 5px;
            color: var(--text-color);
            font-weight: 500;
        }
        .flow-diagram p {
            font-size: 0.85em;
            color: var(--text-secondary-color);
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" id="home-link" class="back-link">&larr; Voltar para a P√°gina Inicial</a>
        <h1>üìÑ Documenta√ß√£o T√©cnica - meu-dash</h1>
        <p>Este documento fornece uma vis√£o detalhada da arquitetura, fluxo de dados, l√≥gica de an√°lise e guia de desenvolvimento do projeto <code>meu-dash</code>.</p>

        <section id="arquitetura">
            <h2>1. Arquitetura e Componentes</h2>
            <div class="card" style="border-left: 4px solid var(--accent-color);">
                <p>A aplica√ß√£o foi refatorada para uma arquitetura moderna e desacoplada, composta por um <strong>backend de API pura</strong> e um <strong>frontend Single-Page Application (SPA)</strong>. Esta abordagem melhora a escalabilidade, a flexibilidade e a experi√™ncia de desenvolvimento.</p>
                <ul>
                    <li><strong>Backend (API RESTful):</strong> Uma aplica√ß√£o <strong>Flask</strong> que exp√µe endpoints para manipula√ß√£o de dados e acionamento de an√°lises. Ele √© respons√°vel pela l√≥gica de neg√≥cio, mas n√£o renderiza nenhuma p√°gina da interface principal. Sua √∫nica responsabilidade √© servir e receber dados no formato <strong>JSON</strong>.</li>
                    <li><strong>Frontend (SPA):</strong> Uma aplica√ß√£o <strong>React</strong> (constru√≠da com Vite) que roda inteiramente no navegador do usu√°rio. Ela consome a API do backend para buscar dados, enviar arquivos e apresentar a interface de forma rica e interativa.</li>
                </ul>
            </div>

            <h4>Diagrama de Componentes</h4>
            <div class="card">
                <p>O diagrama abaixo ilustra a nova arquitetura desacoplada, mostrando a intera√ß√£o entre o usu√°rio, o frontend e o backend.</p>
                <div class="mermaid">
graph TB
    User[("Usu√°rio")] -- "Interage com" --> Frontend

    subgraph "Frontend (SPA no Navegador)"
        Frontend["React App<br><b>(Vite)</b><br>Gerencia a UI e o estado."]
    end

    Frontend -- "Requisi√ß√µes HTTP (JSON)" --> BackendAPI

    subgraph "Backend (Cont√™iner Docker)"
        BackendAPI["Flask API<br><b>(Controller)</b><br>Recebe requisi√ß√µes e delega."]
        Service["Camada de Servi√ßo<br><b>(Orquestrador)</b><br>Executa a l√≥gica de neg√≥cio."]
        Analysis["Motores de An√°lise<br>Processam dados e calculam scores."]
        DB["Banco de Dados<br><b>(SQLite)</b><br>Persiste metadados."]
    end

    BackendAPI --> Service
    Service --> Analysis
    Service --> DB
                </div>
            </div>

            <h4>Componentes Principais</h4>
            <div class="card">
                <p>O projeto est√° dividido em dois diret√≥rios principais: <code>backend/</code> e <code>frontend/</code>.</p>
                
                <h5 style="margin-top: 20px; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px;">Backend (<code>backend/src/</code>)</h5>
                <ul>
                    <li><code>app.py</code>: Ponto de entrada da API Flask. Define os endpoints da API (ex: <code>/api/v1/dashboard-summary</code>), gerencia as requisi√ß√µes HTTP e delega toda a l√≥gica para a camada de servi√ßo.</li>
                    <li><code>services.py</code>: O c√©rebro da aplica√ß√£o. Orquestra o fluxo de an√°lise, interage com o banco de dados (usando os modelos <code>Report</code> e <code>TrendAnalysis</code> para garantir a continuidade da an√°lise de tend√™ncia) e coordena a chamada aos motores de an√°lise e geradores de p√°gina.</li>
                    <li><code>analisar_alertas.py</code>: Motor de an√°lise principal. Processa um arquivo <code>.csv</code>, agrupa alertas em casos e calcula o score de prioridade para cada um.</li>
                    <li><code>analise_tendencia.py</code>: Motor de an√°lise comparativa. Compara os resultados de dois per√≠odos e gera o relat√≥rio de tend√™ncia, incluindo o "Diagn√≥stico R√°pido" com links contextuais para os planos de a√ß√£o.</li>
                    <li><code>gerador_paginas.py</code>: Respons√°vel por usar os dados analisados para gerar os **artefatos** de relat√≥rio (arquivos HTML est√°ticos).</li>
                </ul>

                <h5 style="margin-top: 25px; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px;">Frontend (<code>frontend/src/</code>)</h5>
                <ul>
                    <li><code>main.jsx</code>: Ponto de entrada da aplica√ß√£o React.</li>
                    <li><code>App.jsx</code>: Componente raiz que gerencia o roteamento e o layout principal.</li>
                    <li><code>components/</code>: Diret√≥rio contendo os componentes reutiliz√°veis da UI (ex: `Dashboard.jsx`, `UploadForm.jsx`).</li>
                    <li><code>services/</code>: M√≥dulos respons√°veis por fazer as chamadas √† API do backend.</li>
                </ul>
            </div>
        </section>

        <section id="fluxo">
            <h2>2. Fluxo de Dados Detalhado</h2>
            <p>O fluxo abaixo detalha as etapas desde a intera√ß√£o do usu√°rio no frontend at√© a resposta da API do backend.</p>
            <div class="card" style="padding: 30px;">
                <div class="mermaid">
sequenceDiagram
    actor User as Usu√°rio
    participant Frontend as React App (SPA)
    participant Backend as Flask API
    participant DB as Banco de Dados (SQLite)

    User->>+Frontend: Interage com a UI (ex: clica em "Upload")
    Frontend->>+Backend: Envia requisi√ß√£o HTTP (ex: POST /api/v1/upload com arquivo)
    Backend->>Backend: Camada de Servi√ßo orquestra a an√°lise
    Backend->>DB: Consulta e salva metadados
    Backend->>Backend: Gera artefatos de relat√≥rio (HTML/CSV)
    Backend-->>-Frontend: Retorna resposta JSON (ex: { "report_url": "/path/to/report.html" })
    Frontend-->>-User: Atualiza a UI com o resultado (ex: mostra link para o relat√≥rio)
                </div>
            </div>
        </section>

        <section id="deployment">
            <h2>3. Implanta√ß√£o e Desenvolvimento Local</h2>

            <h3>Desenvolvimento Local (Recomendado)</h3>
            <div class="card">
                <p>O m√©todo recomendado para desenvolvimento √© usar <strong>Docker Compose</strong>, que orquestra os cont√™ineres do backend e do frontend, garantindo um ambiente consistente e isolado.</p>
                <pre><code># 1. Clone o reposit√≥rio e entre no diret√≥rio
git clone &lt;URL_DO_REPOSITORIO&gt; &amp;&amp; cd meu-dash

# 2. Inicie todo o ambiente (backend + frontend)
make up

# 3. (Apenas na primeira vez) Aplique as migra√ß√µes do banco de dados
make migrate-docker</code></pre>
                <p>Ap√≥s a execu√ß√£o, os servi√ßos estar√£o dispon√≠veis:</p>
                <ul>
                    <li><strong>Frontend (Aplica√ß√£o Principal):</strong> <a href="http://127.0.0.1:5174">http://127.0.0.1:5174</a></li>
                    <li><strong>Backend (API):</strong> <a href="http://127.0.0.1:5001">http://127.0.0.1:5001</a></li>
                </ul>
                <p>Para parar todo o ambiente, use <code>make down</code>.</p>
            </div>

            <h3>Implanta√ß√£o em Produ√ß√£o</h3>
            <div class="card">
                <h4><code>Dockerfile</code></h4>
                <p>O projeto utiliza Dockerfiles multi-est√°gio para criar imagens de produ√ß√£o otimizadas tanto para o backend quanto para o frontend. O pipeline de CI/CD √© respons√°vel por construir essas imagens e public√°-las em um registro de cont√™ineres.</p>
                <h4><code>kubernetes.yaml</code></h4>
                <p>Define os recursos para implanta√ß√£o em Kubernetes, incluindo <strong>StatefulSet</strong> e <strong>PersistentVolumeClaim</strong>. O manifesto est√° configurado para injetar o <code>ADMIN_TOKEN</code> como uma vari√°vel de ambiente a partir de um <strong>Kubernetes Secret</strong>. Para detalhes sobre como criar e gerenciar este segredo, consulte a se√ß√£o "Guia de Contribui√ß√£o" abaixo.</p>
            </div>
        </section>

        <section id="logica">
            <h2>4. L√≥gica de An√°lise e Prioriza√ß√£o</h2>
            <p>A an√°lise se baseia em conceitos-chave para transformar "ru√≠do" em insights acion√°veis.</p>
            
            <h3>Casos vs. Alertas</h3>
            <div class="card">
                <p>A an√°lise agrupa m√∫ltiplos alertas da mesma natureza em um mesmo recurso em um √∫nico <strong>Caso</strong>, permitindo focar na causa raiz.</p>
            </div>

            <h3>Score de Prioridade Ponderado</h3>
            <div class="card">
                <p>A criticidade de um caso √© calculada pela f√≥rmula:</p>
                <pre><code>Score Final = (Risco) * (Inefici√™ncia) * (Impacto)</code></pre>
                
                <h4>Pilar 1: Score de Risco (Criticidade Base)</h4>
                <p>Mede a gravidade inerente do problema (Severidade + Prioridade).</p>

                <h4>Pilar 2: Multiplicador de Inefici√™ncia (Falha da Automa√ß√£o)</h4>
                <p>Penaliza casos onde a automa√ß√£o de remedia√ß√£o falhou.</p>

                <h4>Pilar 3: Multiplicador de Impacto (Volume de Alertas)</h4>
            </div>

            <h3>Valida√ß√£o e Qualidade dos Dados</h3>
            <div class="card">
                <p>Para garantir a confiabilidade dos relat√≥rios, a aplica√ß√£o realiza uma valida√ß√£o rigorosa dos dados de entrada, um processo que ocorre na fun√ß√£o <code>carregar_dados()</code> do m√≥dulo <code>analisar_alertas.py</code>.</p>
                <ul>
                    <li><strong>Verifica√ß√£o de Colunas:</strong> O sistema verifica se as colunas essenciais para a an√°lise est√£o presentes no arquivo <code>.csv</code>. A aus√™ncia de colunas cr√≠ticas interrompe o processo com um erro.</li>
                    <li><strong>Tratamento de Dados Inv√°lidos:</strong> Linhas que cont√™m valores inesperados (por exemplo, no status da remedia√ß√£o) s√£o separadas do conjunto de dados principal e registradas em um arquivo <code>invalidos.csv</code>, localizado na pasta do relat√≥rio.</li>
                </ul>
                <p>Essa abordagem assegura que a an√°lise n√£o seja comprometida por dados inconsistentes e fornece um artefato claro para que a equipe respons√°vel possa corrigir a fonte dos dados.</p>
            </div>
        </section>

        <section id="contribuicao">
            <h2>5. Guia de Contribui√ß√£o</h2>
            <p>Para detalhes sobre como configurar o ambiente, rodar testes e seguir os padr√µes de c√≥digo, consulte o <a href="../CONTRIBUTING.md">Guia de Contribui√ß√£o (<code>CONTRIBUTING.md</code>)</a>.</p>

            <h3>Padr√µes de C√≥digo e Qualidade</h3>
            <div class="card">
                <p>O projeto imp√µe um alto padr√£o de qualidade atrav√©s de um pipeline de valida√ß√£o automatizado, que pode ser executado localmente com um √∫nico comando:</p>
                <pre><code># Roda todas as verifica√ß√µes: lint, formata√ß√£o, seguran√ßa e testes (backend + frontend)
make validate-all-docker</code></pre>
                <ul>
                    <li><strong>Backend:</strong> Utiliza <strong>Ruff</strong> para formata√ß√£o e linting, e <strong>Bandit</strong> para an√°lise de seguran√ßa.</li>
                    <li><strong>Frontend:</strong> Utiliza <strong>ESLint</strong> para linting e <strong>Prettier</strong> para formata√ß√£o.</li>
                </ul>
            </div>

            <h3>Executando os Testes</h3>
            <div class="card">
                <p>Os testes s√£o uma parte crucial do pipeline e podem ser executados de forma granular:</p>
                <pre><code># Executa os testes do backend (pytest)
make test-backend-docker

# Executa os testes do frontend (vitest)
make test-frontend-docker</code></pre>
            </div>

            <h3>Processo de Pull Request (PR)</h3>
            <div class="card">
                <ol>
                    <li>Crie uma nova branch a partir da <code>main</code> (ex: <code>git checkout -b feature/minha-feature</code>).</li>
                    <li>Fa√ßa suas altera√ß√µes.</li>
                    <li>Garanta a qualidade do c√≥digo rodando <code>make check</code> e <code>make test</code>.</li>
                    <li>Fa√ßa o commit com uma mensagem clara e concisa.</li>
                    <li>Abra o Pull Request para a branch <code>main</code>, descrevendo suas altera√ß√µes.</li>
                </ol>
            </div>
        </section>

    </div>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        // Inicializa o Mermaid para renderizar os diagramas.
        mermaid.initialize({ startOnLoad: true });

        // Define dinamicamente o link de retorno com base na vari√°vel de ambiente
        // injetada pelo backend, garantindo portabilidade entre ambientes.
        document.addEventListener('DOMContentLoaded', function() {
            const homeLink = document.getElementById('home-link');
            homeLink.href = '{{ FRONTEND_BASE_URL }}' || '/';
        });
    </script>
</body>
</html>