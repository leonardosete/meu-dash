<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documenta√ß√£o T√©cnica - Dash Alertas</title>
    <style>
        :root {
            --bg-color: #1a1c2f;
            --card-color: #2c2f48;
            --text-color: #f0f0f0;
            --text-secondary-color: #a0a0b0;
            --border-color: #404466;
            --accent-color: #4e73df;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }
        h1, h2, h3, h4 {
            color: var(--text-color);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        h1 { font-size: 2.5em; margin-bottom: 20px; }
        h2 { font-size: 1.8em; margin-top: 50px; }
        h3 { font-size: 1.4em; margin-top: 40px; border-bottom-style: dashed; }
        h4 { font-size: 1.1em; margin-top: 30px; border-bottom: none; color: var(--accent-color); }
        p { color: var(--text-secondary-color); }
        a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }
        code {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.9em;
            color: var(--warning-color);
        }
        pre {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }
        pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--text-secondary-color);
        }
        .card {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
        }
        ul, ol {
            padding-left: 20px;
            color: var(--text-secondary-color);
        }
        li { margin-bottom: 10px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background-color: #262940;
            font-weight: bold;
            text-align: center;
        }
        td {
            background-color: #33365a;
        }
        td:first-child {
            font-weight: 500;
            color: var(--text-color);
        }
        td:nth-child(2) { text-align: center; }
        .flow-diagram {
            list-style: none;
            padding: 0;
            position: relative;
        }
        .flow-diagram li {
            padding: 20px;
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 30px;
            position: relative;
        }
        .flow-diagram li::after {
            content: '‚Üì';
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5em;
            color: var(--accent-color);
        }
        .flow-diagram li:last-child::after {
            content: '';
        }
        .flow-diagram strong {
            color: var(--accent-color);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ Documenta√ß√£o T√©cnica - Dash Alertas</h1>
        <p>Este documento fornece uma vis√£o detalhada da arquitetura, fluxo de dados e l√≥gica de an√°lise do projeto <code>meu-dash</code>.</p>

        <section id="descricao">
            <h2>1. Descri√ß√£o do Projeto</h2>
            <div class="card">
                <p>O projeto <strong>Dash Alertas</strong> automatiza a an√°lise de alertas de monitoramento (extra√≠dos de arquivos <code>.csv</code>), gera um ecossistema de dashboards HTML interativos para gest√£o e identifica tend√™ncias de problemas ao longo do tempo.</p>
                <p>O principal diferencial do sistema √© a sua capacidade de classificar problemas com base em um <strong>Score de Prioridade Ponderado</strong>, que considera o risco para o neg√≥cio, a inefici√™ncia da automa√ß√£o e o impacto operacional (volume de alertas), permitindo que as equipes foquem no que √© mais cr√≠tico.</p>
            </div>
        </section>

        <section id="logica">
            <h2>2. L√≥gica de An√°lise e Prioriza√ß√£o</h2>
            <p>A an√°lise se baseia em conceitos-chave para transformar "ru√≠do" (milhares de alertas) em insights acion√°veis (casos priorizados).</p>
            
            <h3>Casos vs. Alertas</h3>
            <div class="card">
                <p>Para focar na causa raiz, a an√°lise distingue <strong>Alertas</strong> de <strong>Casos</strong>:</p>
                <ul>
                    <li><strong>Alerta:</strong> Uma notifica√ß√£o individual de um evento de monitoramento.</li>
                    <li><strong>Caso:</strong> A causa raiz de um problema. Ele agrupa m√∫ltiplos alertas do mesmo tipo que ocorrem em um mesmo recurso (CI/N√≥), representando uma √∫nica frente de trabalho.</li>
                </ul>
                <pre><code>Exemplo: Um servidor com pouco espa√ßo em disco pode gerar 100 alertas de "disco cheio". No entanto, como todos se referem √† mesma causa raiz no mesmo recurso, eles s√£o agrupados em apenas 1 Caso.</code></pre>
            </div>

            <h3>Score de Prioridade Ponderado</h3>
            <div class="card">
                <p>A criticidade de um caso √© calculada pela f√≥rmula:</p>
                <pre><code>Score Final = (Pilar 1: Risco) * (Pilar 2: Inefici√™ncia) * (Pilar 3: Impacto)</code></pre>
                
                <h4>Pilar 1: Score de Risco (Criticidade Base)</h4>
                <p>Mede a gravidade inerente do problema. √â a soma dos pesos da <strong>Severidade</strong> e <strong>Prioridade</strong> do alerta, extra√≠dos das colunas <code>severity</code> e <code>sn_priority_group</code>.</p>
                <table>
                    <thead><tr><th>Severidade</th><th>Peso</th><th>Prioridade</th><th>Peso</th></tr></thead>
                    <tbody>
                        <tr><td>Cr√≠tico</td><td>10</td><td>Urgente</td><td>10</td></tr>
                        <tr><td>Alto / Major</td><td>8</td><td>Alto(a)</td><td>8</td></tr>
                        <tr><td>M√©dio / Minor</td><td>5</td><td>Moderado(a)</td><td>5</td></tr>
                        <tr><td>Aviso / Baixo</td><td>2-3</td><td>Baixo(a)</td><td>2</td></tr>
                    </tbody>
                </table>

                <h4>Pilar 2: Multiplicador de Inefici√™ncia (Falha da Automa√ß√£o)</h4>
                <p>Penaliza casos onde a automa√ß√£o de remedia√ß√£o falhou.</p>
                <table>
                    <thead><tr><th>Resultado da Automa√ß√£o</th><th>Multiplicador</th></tr></thead>
                    <tbody>
                        <tr><td>Falha Persistente (nunca funcionou)</td><td>x 1.5</td></tr>
                        <tr><td>Intermitente (falha √†s vezes)</td><td>x 1.2</td></tr>
                        <tr><td>Status Ausente / Inconsistente</td><td>x 1.1</td></tr>
                        <tr><td>Funcionou no final (Estabilizada / OK)</td><td>x 1.0</td></tr>
                    </tbody>
                </table>

                <h4>Pilar 3: Multiplicador de Impacto (Volume de Alertas)</h4>
                <p>Penaliza o "ru√≠do" operacional. O c√°lculo usa a f√≥rmula <code>1 + ln(N)</code> (logaritmo natural).</p>
                <table>
                    <thead><tr><th>N¬∫ de Alertas no Caso</th><th>Multiplicador Aprox.</th></tr></thead>
                    <tbody>
                        <tr><td>1 alerta</td><td>x 1.0</td></tr>
                        <tr><td>10 alertas</td><td>x 3.3</td></tr>
                        <tr><td>50 alertas</td><td>x 4.9</td></tr>
                        <tr><td>100 alertas</td><td>x 5.6</td></tr>
                    </tbody>
                </table>
            </div>

            <h3>Contabiliza√ß√£o da Remedia√ß√£o</h3>
            <div class="card">
                <p>A an√°lise da remedia√ß√£o se baseia na coluna <code>self_healing_status</code>. O script <code>analisar_alertas.py</code> verifica o valor para cada alerta:</p>
                <ul>
                    <li><code>REM_OK</code>: Sucesso.</li>
                    <li><code>REM_NOT_OK</code>: Falha.</li>
                    <li>Ausente ou outro valor: Status desconhecido ou inv√°lido.</li>
                </ul>
                <p>A sequ√™ncia desses status ao longo do tempo para um mesmo <strong>Caso</strong> define a <strong>A√ß√£o Sugerida</strong> (ex: "Falha Persistente", "Intermitente", "Estabilizada").</p>
            </div>

            <h3>Qualidade dos Dados: Status de Remedia√ß√£o</h3>
            <div class="card">
                <p>Para garantir a integridade da an√°lise, o script <code>analisar_alertas.py</code> realiza uma valida√ß√£o na coluna <code>self_healing_status</code>.</p>
                <ul>
                    <li><strong>Valores Esperados:</strong> <code>REM_OK</code>, <code>REM_NOT_OK</code>, ou valores nulos/vazios.</li>
                    <li><strong>A√ß√£o em caso de Inconsist√™ncia:</strong> Se um valor diferente dos esperados for encontrado, a linha inteira do alerta √© registrada no arquivo <code>invalid_self_healing_status.csv</code>.</li>
                    <li><strong>Notifica√ß√£o:</strong> O dashboard principal (<code>resumo_geral.html</code>) exibir√° um aviso e um link para o <code>qualidade_dados_remediacao.html</code>, permitindo a f√°cil depura√ß√£o e identifica√ß√£o de problemas na coleta de dados.</li>
                </ul>
            </div>
        </section>

        <section id="arquitetura">
            <h2>3. Arquitetura e Componentes</h2>
            <p>A arquitetura do projeto foi modernizada, migrando de um sistema baseado em scripts para uma <strong>aplica√ß√£o web Flask</strong> que centraliza toda a l√≥gica de orquestra√ß√£o e an√°lise.</p>
            
            <h3>1. Orquestrador Principal: Aplica√ß√£o Flask (<code>src/app.py</code>)</h3>
            <div class="card">
                <ul>
                    <li><strong>Responsabilidade:</strong> Atua como um "controlador" enxuto. √â o ponto de entrada da aplica√ß√£o web, gerenciando as rotas (endpoints), as requisi√ß√µes do usu√°rio e delegando toda a l√≥gica de neg√≥cio para a camada de servi√ßo.</li>
                     <li><strong>Componentes Internos:</strong>
                        <ul>
                            <li><strong>Flask:</strong> Microframework web que estrutura a aplica√ß√£o.</li>
                            <li><strong>SQLAlchemy:</strong> ORM para interagir com o banco de dados SQLite, gerenciando o hist√≥rico de relat√≥rios.</li>
                            <li><strong>Flask-Migrate:</strong> Ferramenta para gerenciar as migra√ß√µes do esquema do banco de dados.</li>
                        </ul>
                    </li>
                    <li><strong>Rotas Principais:</strong>
                        <ul>
                            <li><code>GET /</code>: Exibe a p√°gina inicial de upload (<code>upload.html</code>).</li>
                            <li><code>POST /upload</code>: Recebe o arquivo do usu√°rio e chama o <code>services.py</code> para process√°-lo.</li>
                            <li><code>POST /compare</code>: Recebe dois arquivos e chama o servi√ßo de compara√ß√£o direta.</li>
                            <li><code>GET /relatorios</code>: Exibe um hist√≥rico de todos os relat√≥rios gerados, com links para visualiz√°-los.</li>
                            <li><code>GET /reports/&lt;run_folder&gt;/&lt;filename&gt;</code>: Serve os arquivos de relat√≥rio (HTML, CSV, etc.) de uma execu√ß√£o espec√≠fica.</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <h3>2. Camada de Servi√ßo (<code>src/services.py</code>)</h3>
            <div class="card">
                <ul>
                    <li><strong>Responsabilidade:</strong> Cont√©m a l√≥gica de neg√≥cio principal da aplica√ß√£o. Orquestra todo o fluxo de trabalho para a gera√ß√£o de um relat√≥rio, desde o recebimento do arquivo at√© a grava√ß√£o no banco de dados.</li>
                    <li><strong>Invoca√ß√£o:</strong> √â chamado pelo <code>app.py</code> (controlador) quando uma nova an√°lise √© solicitada.</li>
                    <li><strong>Fluxo Interno:</strong>
                        <ol type="a">
                            <li>Salva o arquivo de upload e consulta o banco de dados pelo relat√≥rio anterior.</li>
                            <li>Orquestra a an√°lise de tend√™ncia (chamando <code>analisar_alertas</code> e <code>analise_tendencia</code>).</li>
                            <li>Orquestra a an√°lise principal completa (chamando <code>analisar_alertas</code>).</li>
                            <li>Constr√≥i o dicion√°rio de contexto (chamando <code>context_builder</code>) e orquestra a gera√ß√£o das p√°ginas HTML (chamando <code>gerador_paginas</code>).</li>
                            <li>Salva o novo registro do relat√≥rio no banco de dados.</li>
                        </ol>
                    </li>
                </ul>
            </div>
            <h3>Banco de Dados (<code>data/meu_dash.db</code>)</h3>
            <div class="card">
                <ul>
                    <li><strong>Tecnologia:</strong> SQLite, gerenciado pelo SQLAlchemy.</li>
                    <li><strong>Modelo de Dados (<code>Report</code>):</strong> Armazena metadados de cada an√°lise, incluindo o nome do arquivo original, o timestamp, os caminhos para os artefatos gerados (<code>resumo_geral.html</code> e <code>resumo_problemas.json</code>) e o intervalo de datas da an√°lise.</li>
                    <li><strong>Responsabilidade:</strong> Manter um hist√≥rico persistente de todas as an√°lises. Este hist√≥rico √© <strong>crucial</strong> para a an√°lise de tend√™ncia, pois permite que a aplica√ß√£o compare o upload atual com a an√°lise mais recente registrada.</li>
                </ul>
            </div>

            <h3>Motores de An√°lise (Invocados como Bibliotecas)</h3>
            <div class="card">
                <h4><code>src/analisar_alertas.py</code></h4>
                <ul>
                    <li><strong>Responsabilidade:</strong> Atua como um motor de an√°lise de dados puro. Sua √∫nica fun√ß√£o √© processar um arquivo de alertas (<code>.csv</code>) e gerar os artefatos de <strong>dados</strong> (outros <code>.csv</code> e um <code>resumo_problemas.json</code>). <strong>N√£o possui conhecimento sobre HTML ou apresenta√ß√£o.</strong></li>
                    <li><strong>Invoca√ß√£o:</strong> √â chamado pela camada de servi√ßo (<code>services.py</code>).</li>
                    <li><strong>Sa√≠das (Outputs):</strong> Retorna um dicion√°rio contendo os DataFrames da an√°lise e os caminhos para os arquivos de dados gerados.</li>
                </ul>
                <h4><code>src/analise_tendencia.py</code></h4>
                <ul>
                    <li><strong>Responsabilidade:</strong> Comparar dois per√≠odos (JSON atual vs. JSON anterior) e gerar um <strong>dicion√°rio de contexto</strong> com os dados para o relat√≥rio de tend√™ncia.</li>
                    <li><strong>Invoca√ß√£o:</strong> √â chamado pela camada de servi√ßo (<code>services.py</code>).</li>
                    <li><strong>Sa√≠das (Outputs):</strong> Retorna um dicion√°rio de contexto que ser√° usado pelo controlador para renderizar o template <code>relatorio_tendencia.html</code>.</li>
                </ul>
            </div>
            
            <h3>M√≥dulos Auxiliares</h3>
            <div class="card">
                <h4><code>src/gerador_html.py</code></h4>
                <p>Centraliza a l√≥gica de renderiza√ß√£o de componentes HTML, transformando os dados da an√°lise em dashboards interativos.</p>
                <h4><code>src/gerador_paginas.py</code></h4>
                <p>Orquestra a cria√ß√£o das diversas p√°ginas HTML do relat√≥rio, utilizando <code>gerador_html.py</code> para construir as se√ß√µes e salvando os arquivos finais.</p>
                <h4><code>src/utils.py</code></h4>
                <p>Fornece fun√ß√µes utilit√°rias, como a sanitiza√ß√£o de nomes de arquivos, usadas em v√°rias partes do projeto.</p>
                <h4><code>src/constants.py</code></h4>
                <p>Centraliza todas as constantes de l√≥gica de neg√≥cio (pesos, a√ß√µes, etc.) para garantir consist√™ncia.</p>
                <h4><code>src/get_date_range.py</code></h4>
                <p>Respons√°vel por ler um arquivo de alertas e extrair a data mais antiga e a mais recente, retornando um intervalo de datas formatado.</p>
            </div>
        </section>

        <section id="fluxo">
            <h2>4. Fluxo de Execu√ß√£o L√≥gico</h2>
            <p>O processo √© iniciado pela intera√ß√£o do usu√°rio com a interface web e orquestrado integralmente pelo <code>app.py</code>.</p>
            <ol class="flow-diagram">
                <li>
                    <strong>1. Upload do Usu√°rio:</strong> O usu√°rio acessa a rota <code>/</code> e envia um arquivo <code>.csv</code> atrav√©s do formul√°rio, que faz um <code>POST</code> para a rota <code>/upload</code>.
                </li>
                <li>
                    <strong>2. Controlador (<code>app.py</code>):</strong> A rota <code>/upload</code> recebe a requisi√ß√£o e imediatamente chama a camada de servi√ßo, passando o arquivo.
                </li>
                <li>
                    <strong>3. Camada de Servi√ßo (<code>services.py</code>):</strong> A fun√ß√£o <code>process_upload_and_generate_reports</code> assume o controle e executa a l√≥gica de neg√≥cio:
                    <ul>
                        <li>a. <strong>Salva o arquivo</strong> e cria um diret√≥rio de sa√≠da para a execu√ß√£o (<code>run_&lt;timestamp&gt;</code>).</li>
                        <li>b. <strong>Consulta o DB</strong> para obter o relat√≥rio mais recente.</li>
                        <li>c. **Executa a An√°lise de Tend√™ncia (se aplic√°vel):**
                            <ul>
                                <li>i. Chama <code>analisar_alertas.py</code> em modo <code>light_analysis=True</code> para gerar o JSON do per√≠odo atual.</li>
                                <li>ii. Chama <code>analise_tendencia.py</code> para comparar os JSONs (atual vs. anterior) e gerar o <code>resumo_tendencia.html</code>.</li>
                            </ul>
                        </li>
                        <li>d. <strong>Executa a An√°lise Principal:</strong> Chama <code>analisar_alertas.py</code> em modo <code>light_analysis=False</code> para obter os DataFrames da an√°lise completa.</li>
                        <li>e. <strong>Constr√≥i o Contexto e Gera P√°ginas:</strong> Chama <code>context_builder.py</code> e <code>gerador_paginas.py</code> para renderizar todos os relat√≥rios HTML.</li>
                        <li>f. <strong>Persiste o Resultado:</strong> Cria um novo registro <code>Report</code> no banco de dados.</li>
                    </ul>
                </li>
                <li>
                    <strong>4. Redirecionamento (<code>app.py</code>):</strong> O servi√ßo retorna as informa√ß√µes necess√°rias para o <code>app.py</code>, que ent√£o redireciona o navegador do usu√°rio para o <code>resumo_geral.html</code> rec√©m-criado.
                </li>
            </ol>
        </section>

        <section id="deployment">
            <h2>5. Implanta√ß√£o (Deployment)</h2>
            <p>O projeto √© totalmente containerizado para garantir portabilidade e escalabilidade.</p>
            <div class="card">
                <h4><code>Dockerfile</code></h4>
                <p>Um <code>Dockerfile</code> multi-stage √© fornecido para construir uma imagem de produ√ß√£o otimizada. Ele instala as depend√™ncias Python, inicializa o banco de dados com <strong>Flask-Migrate</strong> e configura a aplica√ß√£o para ser servida com o servidor WSGI <strong>Gunicorn</strong>, pronto para produ√ß√£o.</p>
<pre><code># Exemplo de build
docker build -t meu-dash-web .

# Exemplo de execu√ß√£o
docker run -p 8000:8000 -v ./data:/app/data meu-dash-web</code></pre>
            </div>
            <div class="card">
                <h4><code>kubernetes.yaml</code></h4>
                <p>Para implanta√ß√£o em ambientes orquestrados, o arquivo <code>kubernetes.yaml</code> define os recursos necess√°rios:</p>
                <ul>
                    <li><strong>PersistentVolumeClaim:</strong> Garante que o diret√≥rio <code>/app/data</code> (contendo o banco de dados, uploads e relat√≥rios) seja persistido em um volume de armazenamento.</li>
                    <li><strong>Deployment:</strong> Gerencia os Pods da aplica√ß√£o, garantindo que o n√∫mero desejado de r√©plicas esteja sempre em execu√ß√£o.</li>
                    <li><strong>Service:</strong> Exp√µe o Deployment atrav√©s de um servi√ßo (<code>ClusterIP</code> ou <code>LoadBalancer</code>), tornando a aplica√ß√£o acess√≠vel na rede.</li>
                </ul>
            </div>
        </section>

        <section id="artefatos">
            <h2>6. Artefatos Gerados (Outputs)</h2>
            <h3>Dashboards HTML Interativos</h3>
            <div class="card">
                <ul>
                    <li><strong><code>resumo_geral.html</code>:</strong> Vis√£o geral gerencial. Cont√©m uma se√ß√£o "Conceitos" que explica a metodologia da an√°lise.</li>
                    <li><strong><code>resumo_tendencia.html</code>:</strong> (Modo comparativo) Relat√≥rio de evolu√ß√£o entre os per√≠odos.</li>
                    <li><strong><code>editor_atuacao.html</code>:</strong> Editor interativo para o time atuar sobre os problemas que precisam de a√ß√£o.</li>
                    <li><strong><code>sucesso_automacao.html</code>:</strong> Visualizador de casos resolvidos por automa√ß√£o.</li>
                    <li><strong><code>instabilidade_cronica.html</code>:</strong> Visualizador de casos que s√£o remediados, mas ocorrem com alta frequ√™ncia.</li>
                    <li><strong><code>qualidade_dados_remediacao.html</code>:</strong> (Condicional) Visualizador para os alertas com status de remedia√ß√£o inv√°lido.</li>
                    <li><strong><code>visualizador_json.html</code>:</strong> Ferramenta de depura√ß√£o para visualizar o <code>resumo_problemas.json</code>.</li>
                    <li><strong>Outros:</strong> Planos de a√ß√£o por squad, visualizador de squads, p√°ginas de detalhes, etc.</li>
                </ul>
            </div>
            <h3>Arquivos de Dados</h3>
            <div class="card">
                <ul>
                    <li><strong><code>resumo_problemas.json</code>:</strong> A base de dados principal, com a an√°lise completa do per√≠odo.</li>
                    <li><strong><code>atuar.csv</code>:</strong> Lista de problemas que exigem a√ß√£o manual.</li>
                    <li><strong><code>remediados.csv</code>:</strong> Lista de problemas resolvidos por automa√ß√£o.</li>
                    <li><strong><code>remediados_frequentes.csv</code>:</strong> Lista de problemas que indicam instabilidade cr√¥nica.</li>
                    <li><strong><code>invalid_self_healing_status.csv</code>:</strong> (Condicional) Log com os alertas que possuem um valor de status inesperado.</li>
                </ul>
            </div>
        </section>

    </div>
</body>
</html>
