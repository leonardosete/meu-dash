<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documenta√ß√£o T√©cnica - Dash Alertas</title>
    <style>
        :root {
            --bg-color: #1a1c2f;
            --card-color: #2c2f48;
            --text-color: #f0f0f0;
            --text-secondary-color: #a0a0b0;
            --border-color: #404466;
            --accent-color: #4e73df;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }
        h1, h2, h3, h4 {
            color: var(--text-color);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        h1 { font-size: 2.5em; margin-bottom: 20px; }
        h2 { font-size: 1.8em; margin-top: 50px; }
        h3 { font-size: 1.4em; margin-top: 40px; border-bottom-style: dashed; }
        h4 { font-size: 1.1em; margin-top: 30px; border-bottom: none; color: var(--accent-color); }
        p { color: var(--text-secondary-color); }
        a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }
        code {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.9em;
            color: var(--warning-color);
        }
        pre {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }
        pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--text-secondary-color);
        }
        .card {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
        }
        ul, ol {
            padding-left: 20px;
            color: var(--text-secondary-color);
        }
        li { margin-bottom: 10px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background-color: #262940;
            font-weight: bold;
            text-align: center;
        }
        td {
            background-color: #33365a;
        }
        td:first-child {
            font-weight: 500;
            color: var(--text-color);
        }
        td:nth-child(2) { text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ Documenta√ß√£o T√©cnica - meu-dash</h1>
        <p>Este documento fornece uma vis√£o detalhada da arquitetura, fluxo de dados, l√≥gica de an√°lise e guia de desenvolvimento do projeto <code>meu-dash</code>.</p>

        <section id="arquitetura">
            <h2>1. Arquitetura e Componentes</h2>
            <div class="card">
                <p>A aplica√ß√£o segue uma arquitetura de <strong>3 camadas</strong>, projetada para garantir a separa√ß√£o de responsabilidades e facilitar a manuten√ß√£o:</p>
                <ul>
                    <li><strong>Camada de Apresenta√ß√£o (Flask Web):</strong> Respons√°vel por renderizar a interface do usu√°rio, receber requisi√ß√µes HTTP e servir os relat√≥rios.</li>
                    <li><strong>Camada de Servi√ßo:</strong> Orquestra a l√≥gica de neg√≥cio, atuando como uma ponte entre a camada web e os motores de an√°lise.</li>
                    <li><strong>Camada de An√°lise e Dados:</strong> Cont√©m os motores que processam os dados, aplicam a l√≥gica de neg√≥cio e geram os resultados.</li>
                </ul>
                <p>Para uma descri√ß√£o mais detalhada, consulte o arquivo <a href="../ARCHITECTURE.md"><code>ARCHITECTURE.md</code></a> na raiz do projeto.</p>
            </div>

            <h4>Componentes Principais</h4>
            <div class="card">
                <ul>
                    <li><code>src/app.py</code>: Ponto de entrada da aplica√ß√£o Flask. Define as rotas, gerencia as requisi√ß√µes e delega a l√≥gica para a camada de servi√ßo.</li>
                    <li><code>src/services.py</code>: O c√©rebro da aplica√ß√£o. Orquestra o fluxo de an√°lise, interage com o banco de dados e coordena a gera√ß√£o de relat√≥rios.</li>
                    <li><code>src/analisar_alertas.py</code>: Motor de an√°lise que processa um arquivo <code>.csv</code>, agrupa alertas em casos e calcula o score de prioridade.</li>
                    <li><code>src/analise_tendencia.py</code>: Motor que compara dois per√≠odos de an√°lise e gera o relat√≥rio de tend√™ncia.</li>
                    <li><code>data/meu_dash.db</code>: Banco de dados SQLite que persiste os metadados dos relat√≥rios, essencial para a an√°lise de tend√™ncia.</li>
                </ul>
            </div>
        </section>

        <section id="fluxo">
            <h2>2. Fluxo de Dados (Upload de Arquivo)</h2>
            <p>O diagrama abaixo ilustra o fluxo de dados quando um usu√°rio faz o upload de um novo arquivo para an√°lise.</p>
            <div class="card">
                <div class="mermaid">
sequenceDiagram
    participant User as Usu√°rio
    participant App as Flask App (app.py)
    participant Service as Camada de Servi√ßo (services.py)
    participant Analysis as M√≥dulos de An√°lise
    participant DB as Banco de Dados (SQLite)

    User->>+App: POST /upload com arquivo.csv
    App->>+Service: Chama `process_upload_and_generate_reports()`
    Service->>Service: Salva o arquivo em `data/uploads`
    Service->>DB: Consulta o √∫ltimo relat√≥rio (para tend√™ncia)
    DB-->>Service: Retorna metadados do relat√≥rio anterior
    
    alt An√°lise de Tend√™ncia Aplic√°vel
        Service->>+Analysis: Executa `analisar_arquivo_csv()` (an√°lise leve do arquivo atual)
        Analysis-->>-Service: Retorna JSON tempor√°rio
        Service->>+Analysis: Chama `gerar_relatorio_tendencia()` com JSON anterior e atual
        Analysis-->>-Service: Gera `resumo_tendencia.html`
    end

    Service->>+Analysis: Executa `analisar_arquivo_csv()` (an√°lise completa)
    Analysis-->>-Service: Retorna dataframes e sum√°rios
    Service->>Service: Chama `context_builder` e `gerador_paginas`
    Service->>Service: Gera todo o ecossistema de relat√≥rios HTML
    
    Service->>+DB: Salva metadados do novo relat√≥rio
    DB-->>-Service: Confirma√ß√£o
    
    Service-->>-App: Retorna o caminho para o relat√≥rio principal
    App->>-User: Redireciona para a p√°gina do relat√≥rio

                </div>
            </div>
        </section>

        <section id="deployment">
            <h2>3. Implanta√ß√£o e Desenvolvimento Local</h2>
            
            <h3>Desenvolvimento Local</h3>
            <div class="card">
                <p>Para executar a aplica√ß√£o localmente, siga os passos abaixo. Para mais detalhes, consulte o <a href="../CONTRIBUTING.md"><code>CONTRIBUTING.md</code></a>.</p>
                <pre><code># 1. Clone o reposit√≥rio e entre no diret√≥rio

# 2. Crie um ambiente virtual e ative-o
python3 -m venv .venv
source .venv/bin/activate

# 3. Instale as depend√™ncias
pip install -r requirements.txt

# 4. Exporte as vari√°veis de ambiente do Flask
export FLASK_APP=src/app.py
export FLASK_DEBUG=True

# 5. Inicialize/Atualize o banco de dados
flask db upgrade

# 6. Inicie o servidor de desenvolvimento
flask run</code></pre>
                <p>A aplica√ß√£o estar√° dispon√≠vel em <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a>.</p>
            </div>

            <h3>Implanta√ß√£o em Produ√ß√£o</h3>
            <div class="card">
                <h4><code>Dockerfile</code></h4>
                <p>O <code>Dockerfile</code> multi-stage constr√≥i uma imagem de produ√ß√£o otimizada, utilizando <strong>Gunicorn</strong> como servidor WSGI.</p>
<pre><code># Build da imagem
docker build -t meu-dash-web .

# Execu√ß√£o do container
docker run -p 8000:8000 -v ./data:/app/data meu-dash-web</code></pre>
                <h4><code>kubernetes.yaml</code></h4>
                <p>Define os recursos para implanta√ß√£o em Kubernetes, incluindo <strong>PersistentVolumeClaim</strong> para o diret√≥rio <code>/app/data</code>, <strong>Deployment</strong> e <strong>Service</strong>.</p>
            </div>
        </section>

        <section id="logica">
            <h2>4. L√≥gica de An√°lise e Prioriza√ß√£o</h2>
            <p>A an√°lise se baseia em conceitos-chave para transformar "ru√≠do" em insights acion√°veis.</p>
            
            <h3>Casos vs. Alertas</h3>
            <div class="card">
                <p>A an√°lise agrupa m√∫ltiplos alertas da mesma natureza em um mesmo recurso em um √∫nico <strong>Caso</strong>, permitindo focar na causa raiz.</p>
            </div>

            <h3>Score de Prioridade Ponderado</h3>
            <div class="card">
                <p>A criticidade de um caso √© calculada pela f√≥rmula:</p>
                <pre><code>Score Final = (Risco) * (Inefici√™ncia) * (Impacto)</code></pre>
                
                <h4>Pilar 1: Score de Risco (Criticidade Base)</h4>
                <p>Mede a gravidade inerente do problema (Severidade + Prioridade).</p>

                <h4>Pilar 2: Multiplicador de Inefici√™ncia (Falha da Automa√ß√£o)</h4>
                <p>Penaliza casos onde a automa√ß√£o de remedia√ß√£o falhou.</p>

                <h4>Pilar 3: Multiplicador de Impacto (Volume de Alertas)</h4>
                <p>Penaliza o "ru√≠do" operacional, usando uma escala logar√≠tmica (<code>1 + ln(N)</code>).</p>
            </div>
        </section>

    </div>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>
</html>