<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documenta√ß√£o T√©cnica - Dash Alertas</title>
    <style>
        :root {
            --bg-color: #1a1c2f;
            --card-color: #2c2f48;
            --text-color: #f0f0f0;
            --text-secondary-color: #a0a0b0;
            --border-color: #404466;
            --accent-color: #4e73df;
            --success-color: #1cc88a;
            --warning-color: #d2c83b;
            --danger-color: #e74a3b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            font-weight: 600;
            color: var(--accent-color);
            font-size: 1.1em;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }
        h1, h2, h3, h4 {
            color: var(--text-color);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        h1 { font-size: 1.8em; margin-bottom: 20px; }
        h2 { font-size: 1.8em; margin-top: 50px; }
        h3 { font-size: 1.4em; margin-top: 40px; border-bottom-style: dashed; }
        h4 { font-size: 1.1em; margin-top: 30px; border-bottom: none; color: var(--accent-color); }
        p { color: var(--text-secondary-color); }
        a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }
        code {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.9em;
            color: var(--warning-color);
        }
        pre {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }
        pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--text-secondary-color);
        }
        .card {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
        }
        ul, ol {
            padding-left: 20px;
            color: var(--text-secondary-color);
        }
        li { margin-bottom: 10px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background-color: #262940;
            font-weight: bold;
            text-align: center;
        }
        td {
            background-color: #33365a;
        }
        td:first-child {
            font-weight: 500;
            color: var(--text-color);
        }
        td:nth-child(2) { text-align: center; }
        .flow-diagram {
            display: flex;
            justify-content: space-around;
            list-style: none;
            padding: 0;
            text-align: center;
            gap: 15px;
        }
        .flow-diagram .flow-step {
            flex: 1;
            padding: 10px;
            position: relative;
            min-width: 0; /* Prevent flex items from overflowing */
        }
        .flow-diagram .flow-step:not(:last-child)::after {
            content: '‚Üí';
            position: absolute;
            right: -12px;
            top: 40%;
            transform: translateY(-50%);
            font-size: 2em;
            color: var(--accent-color);
        }
        .flow-diagram .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
        }
        .flow-diagram h4 {
            font-size: 1em;
            margin-bottom: 5px;
            border: none;
            padding-bottom: 5px;
            color: var(--text-color);
            font-weight: 500;
        }
        .flow-diagram p {
            font-size: 0.85em;
            color: var(--text-secondary-color);
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../" class="back-link">&larr; Voltar para a P√°gina Inicial</a>
        <h1>üìÑ Documenta√ß√£o T√©cnica - meu-dash</h1>
        <p>Este documento fornece uma vis√£o detalhada da arquitetura, fluxo de dados, l√≥gica de an√°lise e guia de desenvolvimento do projeto <code>meu-dash</code>.</p>

        <section id="arquitetura">
            <h2>1. Arquitetura e Componentes</h2>
            <div class="card">
                <p>A aplica√ß√£o segue uma arquitetura de <strong>3 camadas</strong>, executando sobre um framework web <strong>Flask</strong>, projetada para garantir a separa√ß√£o de responsabilidades e facilitar a manuten√ß√£o:</p>
                <ul>
                    <li><strong>Camada de Apresenta√ß√£o (Flask Web):</strong> Respons√°vel por renderizar a interface do usu√°rio, receber requisi√ß√µes HTTP e servir os relat√≥rios.</li>
                    <li><strong>Camada de Servi√ßo:</strong> Orquestra a l√≥gica de neg√≥cio, atuando como uma ponte entre a camada web e os motores de an√°lise.</li>
                    <li><strong>Camada de An√°lise e Dados:</strong> Cont√©m os motores que processam os dados, aplicam a l√≥gica de neg√≥cio e geram os resultados.</li>
                </ul>
                <p>O sistema utiliza um banco de dados <strong>SQLite</strong> para persistir metadados sobre os relat√≥rios gerados, permitindo a cria√ß√£o de um hist√≥rico e a funcionalidade de an√°lise de tend√™ncia.</p>
            </div>

            <h4>Diagrama de Componentes</h4>
            <div class="card">
                <p>O diagrama abaixo representa a arquitetura de componentes (baseado no modelo C4 - N√≠vel 2), ilustrando as principais responsabilidades e intera√ß√µes dentro do sistema.</p>
                <div class="mermaid">
graph TB
    subgraph "Sistema meu-dash"
        subgraph "Camada de Apresenta√ß√£o"; A["app.py<br><b>(Flask Controller)</b><br>Recebe uploads, gerencia rotas HTTP."]; end
        subgraph "Camada de Servi√ßo"; B["services.py<br><b>(Orquestrador)</b><br>Coordena a l√≥gica de neg√≥cio."]; end
        subgraph "Camada de An√°lise"; C["analisar_alertas.py<br><b>(Motor de An√°lise)</b><br>Calcula scores e agrupa casos."]; D["analise_tendencia.py<br><b>(Motor de Tend√™ncia)</b><br>Compara relat√≥rios."]; end
        subgraph "Camada de Gera√ß√£o de Relat√≥rios"; E["gerador_paginas.py<br><b>(Gerador de HTML)</b><br>Renderiza os templates."]; F["context_builder.py<br><b>(Builder de Contexto)</b><br>Prepara dados para a view."]; end
        subgraph "Camada de Dados"; G["SQLite DB<br><b>(Banco de Dados)</b><br>Armazena metadados dos relat√≥rios."]; end
    end
    A --"Chama process_upload()"--> B
    B --"Executa an√°lise"--> C
    B --"Executa an√°lise de tend√™ncia"--> D
    B --"Prepara dados para renderizar"--> F
    F --"Fornece contexto para"--> E
    B --"Salva e consulta metadados"--> G
                </div>
            </div>

            <h4>Componentes Principais</h4>
            <div class="card">
                <p>O diret√≥rio <code>src</code> cont√©m os seguintes m√≥dulos, divididos entre l√≥gica principal e m√≥dulos de suporte:</p>
                
                <h5 style="margin-top: 20px; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px;">L√≥gica Principal (Core)</h5>
                <ul>
                    <li><code>app.py</code>: Ponto de entrada da aplica√ß√£o Flask. Define as rotas (<code>/</code>, <code>/upload</code>), gerencia as requisi√ß√µes, delega a l√≥gica para a camada de servi√ßo e fornece filtros de template (ex: convers√£o de timezone).</li>
                    <li><code>services.py</code>: O c√©rebro da aplica√ß√£o. Orquestra o fluxo de an√°lise, interage com o banco de dados (usando os modelos <code>Report</code> e <code>TrendAnalysis</code> para garantir a continuidade da an√°lise de tend√™ncia) e coordena a chamada aos motores de an√°lise e geradores de p√°gina.</li>
                    <li><code>analisar_alertas.py</code>: Motor de an√°lise principal. Processa um arquivo <code>.csv</code>, agrupa alertas em casos e calcula o score de prioridade para cada um.</li>
                    <li><code>analise_tendencia.py</code>: Motor de an√°lise comparativa. Compara os resultados de dois per√≠odos e gera o relat√≥rio de tend√™ncia, incluindo o "Diagn√≥stico R√°pido" com links contextuais para os planos de a√ß√£o.</li>
                    <li><code>gerador_paginas.py</code>: Respons√°vel por usar os dados analisados para gerar o conjunto completo de p√°ginas HTML, incluindo o dashboard principal, relat√≥rios de detalhe e os planos de a√ß√£o pr√©-filtrados por squad (<code>plano-de-acao-&lt;squad&gt;.html</code>).</li>
                </ul>

                <h5 style="margin-top: 25px; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px;">M√≥dulos de Suporte e Configura√ß√£o</h5>
                <ul>
                    <li><code>context_builder.py</code>: Prepara os dicion√°rios de dados (contexto) que s√£o passados para os templates, formatando os resultados da an√°lise para a visualiza√ß√£o.</li>
                    <li><code>gerador_html.py</code>: Cont√©m fun√ß√µes auxiliares de baixo n√≠vel para renderizar componentes HTML espec√≠ficos, como tabelas e gr√°ficos.</li>
                    <li><code>constants.py</code>: Centraliza todas as constantes da aplica√ß√£o, como nomes de colunas, pesos para c√°lculos de score e textos de a√ß√µes.</li>
                    <li><code>utils.py</code>: Fornece fun√ß√µes utilit√°rias gen√©ricas, como a ordena√ß√£o de arquivos por data.</li>
                    <li><code>get_date_range.py</code>: Script utilit√°rio para extrair o intervalo de datas de um arquivo de dados.</li>
                    <li><code>logging_config.py</code>: Configura o sistema de logging da aplica√ß√£o.</li>
                    <li style="margin-top:15px;"><code>data/meu_dash.db</code>: Banco de dados SQLite que persiste os metadados dos relat√≥rios (modelos <code>Report</code> e <code>TrendAnalysis</code>), essencial para o hist√≥rico e a an√°lise de tend√™ncia.</li>
                </ul>
            </div>
        </section>

        <section id="fluxo">
            <h2>2. Fluxo de Dados Detalhado</h2>
            <p>O fluxo abaixo detalha as etapas e os componentes envolvidos desde o upload do arquivo at√© a visualiza√ß√£o do relat√≥rio.</p>
            <div class="card" style="padding: 30px;">
                <div class="mermaid">
sequenceDiagram
    actor User as Usu√°rio
    participant App as Flask App (app.py)
    participant Service as Camada de Servi√ßo (services.py)
    participant Analysis as M√≥dulos de An√°lise
    participant DB as Banco de Dados (SQLite)

    User->>+App: POST /upload com arquivo.csv
    App->>+Service: Chama `process_upload_and_generate_reports()`
    Service->>Service: Salva o arquivo em `data/uploads`
    Service->>DB: Consulta o √∫ltimo relat√≥rio (para tend√™ncia)
    DB-->>Service: Retorna metadados do relat√≥rio anterior
    
    alt An√°lise de Tend√™ncia Aplic√°vel
        Service->>+Analysis: Executa `analisar_arquivo_csv()` (an√°lise leve do arquivo recente)
        Analysis-->>-Service: Retorna JSON tempor√°rio
        Service->>+Analysis: Chama `gerar_relatorio_tendencia()` com JSON anterior e recente
        Analysis-->>-Service: Gera `comparativo_periodos.html`
    end

    Service->>+Analysis: Executa `analisar_arquivo_csv()` (an√°lise completa)
    Analysis-->>-Service: Retorna dataframes e sum√°rios
    Service->>Service: Chama `context_builder` e `gerador_paginas`
    Service->>Service: Gera todo o ecossistema de relat√≥rios HTML
    
    Service->>+DB: Salva metadados do novo relat√≥rio
    DB-->>-Service: Confirma√ß√£o
    
    Service-->>-App: Retorna o caminho para o relat√≥rio principal
    App->>-User: Redireciona para a p√°gina do relat√≥rio
                </div>
            </div>
        </section>

        <section id="deployment">
            <h2>3. Implanta√ß√£o e Desenvolvimento Local</h2>
            
            <h3>Desenvolvimento Local</h3>
            <div class="card">
                <p>O projeto utiliza um <code>Makefile</code> para automatizar as tarefas comuns. Para configurar e executar a aplica√ß√£o pela primeira vez, use um √∫nico comando. Para mais detalhes, consulte a se√ß√£o "Guia de Contribui√ß√£o" abaixo.</p>
                <pre><code># 1. Crie um ambiente virtual e ative-o
git clone &lt;URL_DO_REPOSITORIO&gt;
cd meu-dash

# 2. Configure o ambiente e inicie a aplica√ß√£o
# Este comando √∫nico cuida de tudo: ambiente virtual, depend√™ncias,
# banco de dados e inicializa√ß√£o do servidor.
make setup-and-run</code></pre>
                <p>A aplica√ß√£o estar√° dispon√≠vel em <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a>.</p>
            </div>

            <h3>Implanta√ß√£o em Produ√ß√£o</h3>
            <div class="card">
                <h4><code>Dockerfile</code></h4>
                <p>O <code>Dockerfile</code> multi-stage constr√≥i uma imagem de produ√ß√£o otimizada. Ele configura o timezone para <strong>America/Sao_Paulo</strong> e executa o comando <code>flask db upgrade</code> antes de iniciar o <strong>Gunicorn</strong>, garantindo que o ambiente e o banco de dados estejam sempre corretos na inicializa√ß√£o do container.</p>
<pre><code># Build da imagem
docker build -t meu-dash-web .

# Execu√ß√£o do container
docker run -p 8000:8000 -v ./data:/app/data -e ADMIN_TOKEN="seu-token" meu-dash-web</code></pre>
                <h4><code>kubernetes.yaml</code></h4>
                <p>Define os recursos para implanta√ß√£o em Kubernetes, incluindo <strong>StatefulSet</strong> e <strong>PersistentVolumeClaim</strong>. O manifesto est√° configurado para injetar o <code>ADMIN_TOKEN</code> como uma vari√°vel de ambiente a partir de um <strong>Kubernetes Secret</strong>. Para detalhes sobre como criar e gerenciar este segredo, consulte a se√ß√£o "Guia de Contribui√ß√£o" abaixo.</p>
            </div>
        </section>

        <section id="logica">
            <h2>4. L√≥gica de An√°lise e Prioriza√ß√£o</h2>
            <p>A an√°lise se baseia em conceitos-chave para transformar "ru√≠do" em insights acion√°veis.</p>
            
            <h3>Casos vs. Alertas</h3>
            <div class="card">
                <p>A an√°lise agrupa m√∫ltiplos alertas da mesma natureza em um mesmo recurso em um √∫nico <strong>Caso</strong>, permitindo focar na causa raiz.</p>
            </div>

            <h3>Score de Prioridade Ponderado</h3>
            <div class="card">
                <p>A criticidade de um caso √© calculada pela f√≥rmula:</p>
                <pre><code>Score Final = (Risco) * (Inefici√™ncia) * (Impacto)</code></pre>
                
                <h4>Pilar 1: Score de Risco (Criticidade Base)</h4>
                <p>Mede a gravidade inerente do problema (Severidade + Prioridade).</p>

                <h4>Pilar 2: Multiplicador de Inefici√™ncia (Falha da Automa√ß√£o)</h4>
                <p>Penaliza casos onde a automa√ß√£o de remedia√ß√£o falhou.</p>

                <h4>Pilar 3: Multiplicador de Impacto (Volume de Alertas)</h4>
            </div>

            <h3>Valida√ß√£o e Qualidade dos Dados</h3>
            <div class="card">
                <p>Para garantir a confiabilidade dos relat√≥rios, a aplica√ß√£o realiza uma valida√ß√£o rigorosa dos dados de entrada, um processo que ocorre na fun√ß√£o <code>carregar_dados()</code> do m√≥dulo <code>analisar_alertas.py</code>.</p>
                <ul>
                    <li><strong>Verifica√ß√£o de Colunas:</strong> O sistema verifica se as colunas essenciais para a an√°lise est√£o presentes no arquivo <code>.csv</code>. A aus√™ncia de colunas cr√≠ticas interrompe o processo com um erro.</li>
                    <li><strong>Tratamento de Dados Inv√°lidos:</strong> Linhas que cont√™m valores inesperados (por exemplo, no status da remedia√ß√£o) s√£o separadas do conjunto de dados principal e registradas em um arquivo <code>invalidos.csv</code>, localizado na pasta do relat√≥rio.</li>
                </ul>
                <p>Essa abordagem assegura que a an√°lise n√£o seja comprometida por dados inconsistentes e fornece um artefato claro para que a equipe respons√°vel possa corrigir a fonte dos dados.</p>
            </div>
        </section>

        <section id="contribuicao">
            <h2>5. Guia de Contribui√ß√£o</h2>
            <p>Este guia fornece todas as informa√ß√µes necess√°rias para configurar o ambiente, rodar os testes e contribuir com o projeto.</p>

            <h3>Configura√ß√£o do Ambiente</h3>
            <div class="card">
                <p>O projeto utiliza um <code>Makefile</code> para automatizar todo o processo de configura√ß√£o. Para preparar seu ambiente, siga os passos:</p>
                <pre><code># 1. Clone o reposit√≥rio
git clone &lt;URL_DO_REPOSITORIO&gt;
cd meu-dash

# 2. Execute o setup completo e inicie a aplica√ß√£o
make setup-and-run</code></pre>
                <p>Ap√≥s a configura√ß√£o inicial, voc√™ pode parar e iniciar o servidor de desenvolvimento usando apenas <code>make run</code>.</p>
            </div>

            <h3>Configurando Funcionalidades de Administrador</h3>
            <div class="card">
                <h4>Para Desenvolvimento Local</h4>
                <p>Para testar funcionalidades protegidas, defina a vari√°vel de ambiente <code>ADMIN_TOKEN</code> antes de iniciar a aplica√ß√£o:</p>
                <pre><code># Voc√™ pode usar qualquer valor para o seu token secreto
export ADMIN_TOKEN="seu-token-secreto-aqui"
make run</code></pre>

                <h4>Para Produ√ß√£o (Kubernetes)</h4>
                <p>Em produ√ß√£o, o token deve ser gerenciado atrav√©s de <strong>Kubernetes Secrets</strong>. O manifesto <code>kubernetes.yaml</code> j√° est√° configurado para procurar um Secret com o nome <code>admin-token-secret</code>. Para cri√°-lo, use:</p>
                <pre><code># Substitua pelo valor real
kubectl create secret generic admin-token-secret \
  --from-literal=ADMIN_TOKEN='seu-token-super-secreto-de-producao'</code></pre>
            </div>

            <h3>Padr√µes de C√≥digo e Qualidade</h3>
            <div class="card">
                <p>Para manter o c√≥digo limpo e consistente, utilizamos a ferramenta <strong>Ruff</strong>. O <code>Makefile</code> fornece comandos para simplificar o uso:</p>
                <ul>
                    <li><strong>Para formatar seu c√≥digo:</strong> <code>make format</code></li>
                    <li><strong>Para corrigir erros de linting:</strong> <code>make lint</code></li>
                    <li><strong>Para rodar a verifica√ß√£o completa:</strong> <code>make check</code></li>
                </ul>
            </div>

            <h3>Executando os Testes</h3>
            <div class="card">
                <p>Para garantir que suas altera√ß√µes n√£o quebraram nenhuma funcionalidade, execute a su√≠te de testes com <code>pytest</code> atrav√©s do Makefile:</p>
                <pre><code>make test</code></pre>
                <p>Certifique-se de que todos os testes passam antes de abrir um Pull Request.</p>
            </div>

            <h3>Processo de Pull Request (PR)</h3>
            <div class="card">
                <ol>
                    <li>Crie uma nova branch a partir da <code>main</code> (ex: <code>git checkout -b feature/minha-feature</code>).</li>
                    <li>Fa√ßa suas altera√ß√µes.</li>
                    <li>Garanta a qualidade do c√≥digo rodando <code>make check</code> e <code>make test</code>.</li>
                    <li>Fa√ßa o commit com uma mensagem clara e concisa.</li>
                    <li>Abra o Pull Request para a branch <code>main</code>, descrevendo suas altera√ß√µes.</li>
                </ol>
            </div>
        </section>

    </div>
    <script>
        // Script para corrigir o link "Voltar" e inicializar o Mermaid
        document.addEventListener('DOMContentLoaded', () => {
            const backLink = document.querySelector('.back-link');
            if (backLink) {
                const currentHostname = window.location.hostname;
                let targetUrl = '';

                // Ambiente de desenvolvimento local
                if (currentHostname === '127.0.0.1' || currentHostname === 'localhost') {
                    targetUrl = 'http://127.0.0.1:5174/';
                // Ambiente de produ√ß√£o (GitHub Pages)
                } else if (currentHostname === 'leonardosete.github.io') {
                    targetUrl = 'https://leonardosete.github.io/meu-dash/';
                }
                
                if (targetUrl) {
                    backLink.href = targetUrl;
                }
            }
        });
    </script>
</body>
</html>