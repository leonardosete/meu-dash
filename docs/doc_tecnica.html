<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documenta√ß√£o T√©cnica - Dash Alertas</title>
    <style>
        :root {
            --bg-color: #1a1c2f;
            --card-color: #2c2f48;
            --text-color: #f0f0f0;
            --text-secondary-color: #a0a0b0;
            --border-color: #404466;
            --accent-color: #4e73df;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }
        h1, h2, h3, h4 {
            color: var(--text-color);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        h1 { font-size: 2.5em; margin-bottom: 20px; }
        h2 { font-size: 1.8em; margin-top: 50px; }
        h3 { font-size: 1.4em; margin-top: 40px; border-bottom-style: dashed; }
        h4 { font-size: 1.1em; margin-top: 30px; border-bottom: none; color: var(--accent-color); }
        p { color: var(--text-secondary-color); }
        a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }
        code {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.9em;
            color: var(--warning-color);
        }
        pre {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }
        pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--text-secondary-color);
        }
        .card {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
        }
        ul, ol {
            padding-left: 20px;
            color: var(--text-secondary-color);
        }
        li { margin-bottom: 10px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background-color: #262940;
            font-weight: bold;
            text-align: center;
        }
        td {
            background-color: #33365a;
        }
        td:first-child {
            font-weight: 500;
            color: var(--text-color);
        }
        td:nth-child(2) { text-align: center; }
        .flow-diagram {
            display: flex;
            justify-content: space-around;
            list-style: none;
            padding: 0;
            text-align: center;
            gap: 15px;
        }
        .flow-diagram .flow-step {
            flex: 1;
            padding: 10px;
            position: relative;
            min-width: 0; /* Prevent flex items from overflowing */
        }
        .flow-diagram .flow-step:not(:last-child)::after {
            content: '‚Üí';
            position: absolute;
            right: -12px;
            top: 40%;
            transform: translateY(-50%);
            font-size: 2em;
            color: var(--accent-color);
        }
        .flow-diagram .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
        }
        .flow-diagram h4 {
            font-size: 1em;
            margin-bottom: 5px;
            border: none;
            padding-bottom: 5px;
            color: var(--text-color);
            font-weight: 500;
        }
        .flow-diagram p {
            font-size: 0.85em;
            color: var(--text-secondary-color);
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ Documenta√ß√£o T√©cnica - meu-dash</h1>
        <p>Este documento fornece uma vis√£o detalhada da arquitetura, fluxo de dados, l√≥gica de an√°lise e guia de desenvolvimento do projeto <code>meu-dash</code>.</p>

        <section id="arquitetura">
            <h2>1. Arquitetura e Componentes</h2>
            <div class="card">
                <p>A aplica√ß√£o segue uma arquitetura de <strong>3 camadas</strong>, projetada para garantir a separa√ß√£o de responsabilidades e facilitar a manuten√ß√£o:</p>
                <ul>
                    <li><strong>Camada de Apresenta√ß√£o (Flask Web):</strong> Respons√°vel por renderizar a interface do usu√°rio, receber requisi√ß√µes HTTP e servir os relat√≥rios.</li>
                    <li><strong>Camada de Servi√ßo:</strong> Orquestra a l√≥gica de neg√≥cio, atuando como uma ponte entre a camada web e os motores de an√°lise.</li>
                    <li><strong>Camada de An√°lise e Dados:</strong> Cont√©m os motores que processam os dados, aplicam a l√≥gica de neg√≥cio e geram os resultados.</li>
                </ul>
                <p>Para uma descri√ß√£o mais detalhada, consulte o arquivo <a href="../ARCHITECTURE.md"><code>ARCHITECTURE.md</code></a> na raiz do projeto.</p>
            </div>

            <h4>Componentes Principais</h4>
            <div class="card">
                <p>O diret√≥rio <code>src</code> cont√©m os seguintes m√≥dulos, divididos entre l√≥gica principal e m√≥dulos de suporte:</p>
                
                <h5 style="margin-top: 20px; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px;">L√≥gica Principal (Core)</h5>
                <ul>
                    <li><code>app.py</code>: Ponto de entrada da aplica√ß√£o Flask. Define as rotas (<code>/</code>, <code>/upload</code>), gerencia as requisi√ß√µes, delega a l√≥gica para a camada de servi√ßo e fornece filtros de template (ex: convers√£o de timezone).</li>
                    <li><code>services.py</code>: O c√©rebro da aplica√ß√£o. Orquestra o fluxo de an√°lise, interage com o banco de dados (usando os modelos <code>Report</code> e <code>TrendAnalysis</code> para garantir a continuidade da an√°lise de tend√™ncia) e coordena a chamada aos motores de an√°lise e geradores de p√°gina.</li>
                    <li><code>analisar_alertas.py</code>: Motor de an√°lise principal. Processa um arquivo <code>.csv</code>, agrupa alertas em casos e calcula o score de prioridade para cada um.</li>
                    <li><code>analise_tendencia.py</code>: Motor de an√°lise comparativa. Compara os resultados de dois per√≠odos e gera o relat√≥rio de tend√™ncia.</li>
                    <li><code>gerador_paginas.py</code>: Respons√°vel por usar os dados analisados para gerar o conjunto completo de p√°ginas HTML do relat√≥rio.</li>
                </ul>

                <h5 style="margin-top: 25px; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px;">M√≥dulos de Suporte e Configura√ß√£o</h5>
                <ul>
                    <li><code>context_builder.py</code>: Prepara os dicion√°rios de dados (contexto) que s√£o passados para os templates, formatando os resultados da an√°lise para a visualiza√ß√£o.</li>
                    <li><code>gerador_html.py</code>: Cont√©m fun√ß√µes auxiliares de baixo n√≠vel para renderizar componentes HTML espec√≠ficos, como tabelas e gr√°ficos.</li>
                    <li><code>constants.py</code>: Centraliza todas as constantes da aplica√ß√£o, como nomes de colunas, pesos para c√°lculos de score e textos de a√ß√µes.</li>
                    <li><code>utils.py</code>: Fornece fun√ß√µes utilit√°rias gen√©ricas, como a ordena√ß√£o de arquivos por data.</li>
                    <li><code>get_date_range.py</code>: Script utilit√°rio para extrair o intervalo de datas de um arquivo de dados.</li>
                    <li><code>logging_config.py</code>: Configura o sistema de logging da aplica√ß√£o.</li>
                    <li style="margin-top:15px;"><code>data/meu_dash.db</code>: Banco de dados SQLite que persiste os metadados dos relat√≥rios (modelos <code>Report</code> e <code>TrendAnalysis</code>), essencial para o hist√≥rico e a an√°lise de tend√™ncia.</li>
                </ul>
            </div>
        </section>

        <section id="fluxo">
            <h2>2. Fluxo de Dados Detalhado</h2>
            <p>O fluxo abaixo detalha as etapas e os componentes envolvidos desde o upload do arquivo at√© a visualiza√ß√£o do relat√≥rio.</p>
            <div class="card">
                <div class="flow-diagram">
                    <div class="flow-step">
                        <span class="icon">üì§</span>
                        <h4>1. Upload</h4>
                        <p>Usu√°rio envia o <code>.csv</code> via <code>POST /upload</code>.</p>
                    </div>
                    <div class="flow-step">
                        <span class="icon">‚öôÔ∏è</span>
                        <h4>2. Orquestra√ß√£o</h4>
                        <p><code>services.py</code> recebe o arquivo, consulta o hist√≥rico no DB e coordena as an√°lises.</p>
                    </div>
                    <div class="flow-step">
                        <span class="icon">üî¨</span>
                        <h4>3. Motores de An√°lise</h4>
                        <p><code>analisar_alertas.py</code> processa os dados brutos e gera o sum√°rio de problemas, enquanto <code>analise_tendencia.py</code> compara dois sum√°rios para criar o relat√≥rio de an√°lise de tend√™ncia.</p></p>
                    </div>
                    <div class="flow-step">
                        <span class="icon">üìÑ</span>
                        <h4>4. Gera√ß√£o de Relat√≥rios</h4>
                        <p><code>gerador_paginas.py</code> cria os artefatos HTML a partir dos dados analisados.</p>
                    </div>
                    <div class="flow-step">
                        <span class="icon">üíæ‚û°Ô∏è</span>
                        <h4>5. Finaliza√ß√£o</h4>
                        <p><code>services.py</code> salva os metadados no DB e <code>app.py</code> redireciona o usu√°rio para o resultado.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="deployment">
            <h2>3. Implanta√ß√£o e Desenvolvimento Local</h2>
            
            <h3>Desenvolvimento Local</h3>
            <div class="card">
                <p>O projeto utiliza um <code>Makefile</code> para automatizar as tarefas comuns. Para configurar e executar a aplica√ß√£o pela primeira vez, use um √∫nico comando. Para mais detalhes, consulte o <a href="../CONTRIBUTING.md"><code>CONTRIBUTING.md</code></a>.</p>
                <pre><code># 1. Crie um ambiente virtual e ative-o
git clone &lt;URL_DO_REPOSITORIO&gt;
cd meu-dash

# 2. Configure o ambiente e inicie a aplica√ß√£o
# Este comando √∫nico cuida de tudo: ambiente virtual, depend√™ncias,
# banco de dados e inicializa√ß√£o do servidor.
make setup-and-run</code></pre>
                <p>A aplica√ß√£o estar√° dispon√≠vel em <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a>.</p>
            </div>

            <h3>Implanta√ß√£o em Produ√ß√£o</h3>
            <div class="card">
                <h4><code>Dockerfile</code></h4>
                <p>O <code>Dockerfile</code> multi-stage constr√≥i uma imagem de produ√ß√£o otimizada. Ele configura o timezone para <strong>America/Sao_Paulo</strong> e executa o comando <code>flask db upgrade</code> antes de iniciar o <strong>Gunicorn</strong>, garantindo que o ambiente e o banco de dados estejam sempre corretos na inicializa√ß√£o do container.</p>
<pre><code># Build da imagem
docker build -t meu-dash-web .

# Execu√ß√£o do container
docker run -p 8000:8000 -v ./data:/app/data meu-dash-web</code></pre>
                <h4><code>kubernetes.yaml</code></h4>
                <p>Define os recursos para implanta√ß√£o em Kubernetes, incluindo <strong>StatefulSet</strong> e <strong>PersistentVolumeClaim</strong>. O manifesto est√° configurado para injetar o <code>ADMIN_TOKEN</code> como uma vari√°vel de ambiente a partir de um <strong>Kubernetes Secret</strong>. Para detalhes sobre como criar e gerenciar este segredo, consulte o <a href="../CONTRIBUTING.md">guia de contribui√ß√£o</a>.</p>
            </div>
        </section>

        <section id="logica">
            <h2>4. L√≥gica de An√°lise e Prioriza√ß√£o</h2>
            <p>A an√°lise se baseia em conceitos-chave para transformar "ru√≠do" em insights acion√°veis.</p>
            
            <h3>Casos vs. Alertas</h3>
            <div class="card">
                <p>A an√°lise agrupa m√∫ltiplos alertas da mesma natureza em um mesmo recurso em um √∫nico <strong>Caso</strong>, permitindo focar na causa raiz.</p>
            </div>

            <h3>Score de Prioridade Ponderado</h3>
            <div class="card">
                <p>A criticidade de um caso √© calculada pela f√≥rmula:</p>
                <pre><code>Score Final = (Risco) * (Inefici√™ncia) * (Impacto)</code></pre>
                
                <h4>Pilar 1: Score de Risco (Criticidade Base)</h4>
                <p>Mede a gravidade inerente do problema (Severidade + Prioridade).</p>

                <h4>Pilar 2: Multiplicador de Inefici√™ncia (Falha da Automa√ß√£o)</h4>
                <p>Penaliza casos onde a automa√ß√£o de remedia√ß√£o falhou.</p>

                <h4>Pilar 3: Multiplicador de Impacto (Volume de Alertas)</h4>
            </div>

            <h3>Valida√ß√£o e Qualidade dos Dados</h3>
            <div class="card">
                <p>Para garantir a confiabilidade dos relat√≥rios, a aplica√ß√£o realiza uma valida√ß√£o rigorosa dos dados de entrada, um processo que ocorre na fun√ß√£o <code>carregar_dados()</code> do m√≥dulo <code>analisar_alertas.py</code>.</p>
                <ul>
                    <li><strong>Verifica√ß√£o de Colunas:</strong> O sistema verifica se as colunas essenciais para a an√°lise est√£o presentes no arquivo <code>.csv</code>. A aus√™ncia de colunas cr√≠ticas interrompe o processo com um erro.</li>
                    <li><strong>Tratamento de Dados Inv√°lidos:</strong> Linhas que cont√™m valores inesperados (por exemplo, no status da remedia√ß√£o) s√£o separadas do conjunto de dados principal e registradas em um arquivo <code>invalidos.csv</code>, localizado na pasta do relat√≥rio.</li>
                </ul>
                <p>Essa abordagem assegura que a an√°lise n√£o seja comprometida por dados inconsistentes e fornece um artefato claro para que a equipe respons√°vel possa corrigir a fonte dos dados.</p>
            </div>
        </section>

    </div>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>
</html>