name: cd-deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    env:
      IMAGE_REPO: sevenleo/smart-remedy
      RELEASE_NAME: smart-remedy
      CHART_PATH: helm/smart-remedy
      FRONTEND_NAMESPACE: smart-remedy-frontend
      BACKEND_NAMESPACE: smart-remedy-backend
      BACKEND_DEPLOYMENT: smart-remedy-api
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      ADMIN_USER: ${{ secrets.ADMIN_USER }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: ðŸ” Validar segredos obrigatÃ³rios
        run: |
          [[ -n "$SECRET_KEY" && "$SECRET_KEY" != "None" ]] || { echo "SECRET_KEY ausente ou invÃ¡lido nos segredos do repositÃ³rio"; exit 1; }
          [[ -n "$DATABASE_URL" && "$DATABASE_URL" != "None" ]] || { echo "DATABASE_URL ausente ou invÃ¡lido nos segredos do repositÃ³rio"; exit 1; }

      - name:  Define KUBECONFIG (runner jÃ¡ estÃ¡ na VPS)
        run: echo "KUBECONFIG=/root/.kube/config" >> $GITHUB_ENV

      - name: ðŸ› ï¸ Instala kubectl (fallback)
        run: |
          command -v kubectl || { curl -sLO "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"; chmod +x kubectl && sudo mv kubectl /usr/local/bin/; }

      - name: ï¿½ï¸ Instala Helm (fallback)
        run: |
          command -v helm || { curl -sSL https://get.helm.sh/helm-v3.15.2-linux-amd64.tar.gz -o helm.tar.gz; tar -xzf helm.tar.gz; sudo mv linux-amd64/helm /usr/local/bin/helm; rm -rf linux-amd64 helm.tar.gz; }

      - name: ï¿½ðŸš€ Cria namespaces (idempotente)
        run: |
          kubectl get ns "$FRONTEND_NAMESPACE" 2>/dev/null || kubectl create ns "$FRONTEND_NAMESPACE"
          kubectl get ns "$BACKEND_NAMESPACE" 2>/dev/null || kubectl create ns "$BACKEND_NAMESPACE"

      - name: ðŸ” (Re)cria secret de runtime (smart-remedy-secrets)
        run: |
          kubectl -n "$BACKEND_NAMESPACE" delete secret smart-remedy-secrets 2>/dev/null || true
          CMD=(kubectl -n "$BACKEND_NAMESPACE" create secret generic smart-remedy-secrets \
            --from-literal=SECRET_KEY="$SECRET_KEY" \
            --from-literal=DATABASE_URL="$DATABASE_URL")
          if [[ -n "$ADMIN_USER" ]]; then
            CMD+=(--from-literal=ADMIN_USER="$ADMIN_USER")
          fi
          if [[ -n "$ADMIN_PASSWORD" ]]; then
            CMD+=(--from-literal=ADMIN_PASSWORD="$ADMIN_PASSWORD")
          fi
          "${CMD[@]}"

      - name: ï¿½ Captura versÃ£o da aplicaÃ§Ã£o
        run: echo "APP_VERSION=$(cat VERSION)" >> $GITHUB_ENV

      - name: ï¿½ðŸ“„ Aplica chart Helm
        run: |
          helm upgrade --install "$RELEASE_NAME" "$CHART_PATH" \
            --namespace "$FRONTEND_NAMESPACE" \
            --set image.repository="$IMAGE_REPO" \
            --set image.tag="${{ github.sha }}" \
            --set app.version="$APP_VERSION" \
            --set frontend.namespace="$FRONTEND_NAMESPACE" \
            --set backend.namespace="$BACKEND_NAMESPACE" \
            --set backend.secretName="smart-remedy-secrets"

      - name: ðŸ”Ž Status pÃ³s-deploy
        run: |
          kubectl -n "$FRONTEND_NAMESPACE" get deploy,po,svc,ingress
          kubectl -n "$BACKEND_NAMESPACE" get deploy,po,svc
          kubectl -n "$BACKEND_NAMESPACE" rollout status deploy "$BACKEND_DEPLOYMENT" --timeout=120s || true
