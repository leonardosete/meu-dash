# ü§ñ PAINEL DE CONTROLE DA IA (GEMINI)

## 1. SEU PAPEL E OBJETIVO

**Voc√™ √© um engenheiro de software s√™nior especialista em arquitetura de sistemas**, atuando como o principal assistente para o projeto `meu-dash`.

**Seu objetivo principal √© auxiliar no desenvolvimento, an√°lise, depura√ß√£o e documenta√ß√£o deste projeto**, garantindo que o c√≥digo e a documenta√ß√£o permane√ßam consistentes e de alta qualidade.

## 2. CONTEXTO E FONTE DA VERDADE

- **Diret√≥rio Raiz do Projeto:** `~/meu-dash`
- **Fonte Prim√°ria da Verdade:** **Este arquivo (`GEMINI.md`) √© sua refer√™ncia principal.** Sempre comece lendo-o para entender a arquitetura e o fluxo de dados. O c√≥digo-fonte em `src/app.py` √© a autoridade final sobre o fluxo de execu√ß√£o.
- **Documenta√ß√£o Externa (para Humanos):**
    - `docs/doc_tecnica.html`: Detalhes t√©cnicos da implementa√ß√£o.
    - `docs/doc_gerencial.html`: Vis√£o de alto n√≠vel e impacto para gest√£o.

## 3. REGRAS DE OPERA√á√ÉO

1.  **Sincroniza√ß√£o Obrigat√≥ria:** Qualquer altera√ß√£o no c√≥digo que afete o fluxo de execu√ß√£o, as entradas/sa√≠das de um m√≥dulo ou a estrutura dos relat√≥rios gerados **DEVE** ser refletida imediatamente neste arquivo.
2.  **An√°lise Baseada em Fatos:** Suas an√°lises devem se basear estritamente na arquitetura e no fluxo descritos aqui. N√£o presuma funcionalidades que n√£o estejam documentadas.
3.  **Clareza e Precis√£o:** Ao gerar c√≥digo ou documenta√ß√£o, seja expl√≠cito sobre as depend√™ncias entre os m√≥dulos e os artefatos que eles consomem e produzem.
4.  **Ponto de Partida Fixo:** Toda an√°lise de fluxo de execu√ß√£o come√ßa pela intera√ß√£o do usu√°rio com a interface web, orquestrada pelo `src/app.py`.

---

# üìù DESCRI√á√ÉO DO PROJETO: An√°lise de Alertas e Tend√™ncias

Este projeto √© uma **aplica√ß√£o web Flask** que automatiza a an√°lise de alertas de monitoramento (`.csv`), gera um ecossistema de dashboards HTML interativos e identifica tend√™ncias de problemas ao longo do tempo. A aplica√ß√£o utiliza **processamento ass√≠ncrono com Celery** para tarefas pesadas e integra um **agente de IA** para an√°lise de dados e consulta √† documenta√ß√£o. Foi projetada para ser executada em cont√™iner (Docker) e implantada em Kubernetes.

O sistema classifica os problemas com base em um **Score de Prioridade Ponderado**, que considera o risco do neg√≥cio, a inefici√™ncia da automa√ß√£o e o impacto operacional (volume de alertas).

---

# üß† L√ìGICA DE AN√ÅLISE E PRIORIZA√á√ÉO

A an√°lise se baseia em conceitos-chave para transformar "ru√≠do" (alertas) em insights acion√°veis (casos priorizados).

## Casos vs. Alertas
- **Alerta:** Uma notifica√ß√£o individual de um evento de monitoramento.
- **Caso:** A causa raiz de um problema. Agrupa m√∫ltiplos alertas do mesmo tipo em um mesmo recurso (CI/N√≥).

## Score de Prioridade Ponderado
**Score Final = (Risco) * (Inefici√™ncia) * (Impacto)**
- **Risco:** Gravidade inerente do problema (baseado na severidade e prioridade).
- **Inefici√™ncia:** Penaliza falhas da automa√ß√£o de remedia√ß√£o.
- **Impacto:** Penaliza o "ru√≠do" operacional (volume de alertas).

---

# üèõÔ∏è ARQUITETURA E COMPONENTES

A arquitetura do projeto √© centrada em uma aplica√ß√£o web Flask que orquestra todo o processo de an√°lise e visualiza√ß√£o.

## 1. Orquestrador Principal: Aplica√ß√£o Flask (`src/app.py`)

- **Responsabilidade:** √önico ponto de entrada e c√©rebro do projeto. Gerencia as intera√ß√µes do usu√°rio, dispara tarefas de an√°lise ass√≠ncronas, gerencia a persist√™ncia de dados e serve os relat√≥rios e a interface do chat.
- **Componentes Internos:**
    - **Flask:** Microframework web.
    - **SQLAlchemy:** ORM para interagir com o banco de dados.
    - **Flask-Migrate:** Gerencia as migra√ß√µes do esquema do banco de dados. 
    - **Celery:** Sistema de filas de tarefas para processamento ass√≠ncrono.
- **Rotas Principais:**
    - `GET /`: Exibe a p√°gina inicial de upload (`upload.html`).
    - `POST /upload`: Recebe o arquivo, salva-o e **dispara a tarefa ass√≠ncrona `processar_analise` no Celery**. Retorna um `task_id`.
    - `GET /task/<task_id>` e `GET /status/<task_id>`: Permitem que o frontend consulte o status da tarefa em andamento.
    - `GET /relatorios`: Exibe um hist√≥rico de todos os relat√≥rios gerados, com links para visualiz√°-los.
    - `GET /reports/<run_folder>/<filename>`: Serve os arquivos de relat√≥rio (HTML, CSV, etc.) de uma execu√ß√£o espec√≠fica.
    - `GET /health`: Endpoint de health check para Kubernetes. Retorna um JSON `{'status': 'ok'}`.
    - `POST /report/delete/<int:report_id>`: Exclui um relat√≥rio espec√≠fico, removendo seus arquivos e o registro do banco de dados.
    - `GET /docs/<path:filename>`: Serve a documenta√ß√£o est√°tica do projeto (e.g., `doc_tecnica.html`).
    - `POST /chat/ask`: Endpoint unificado que recebe perguntas do usu√°rio e as encaminha para o agente de IA.

## 2. Processamento Ass√≠ncrono: Tarefa Celery (`processar_analise` em `src/app.py`)
- **Responsabilidade:** Executar todo o pipeline de an√°lise de forma desacoplada da requisi√ß√£o web.
- **Fluxo:** Valida√ß√£o do arquivo, an√°lise de tend√™ncia, an√°lise principal, gera√ß√£o **condicional** de resumo por IA e rota√ß√£o de relat√≥rios antigos.
- **Par√¢metros:** Recebe `use_ai_agent` (booleano) do frontend para decidir se deve ou n√£o invocar a IA para gerar o resumo executivo.
- **Retorno:** Retorna um dicion√°rio contendo a URL do relat√≥rio e o `ai_summary` (se gerado), que √© usado pelo frontend para exibir o card de resumo na p√°gina inicial.

## 3. Banco de Dados (`data/meu_dash.db`)

- **Tecnologia:** SQLite, gerenciado pelo SQLAlchemy.
- **Modelo (`Report`):**
    - `id`: Identificador √∫nico.
    - `timestamp`: Data e hora da an√°lise (quando o processo foi executado).
    - `original_filename`: Nome do arquivo `.csv` que foi enviado.
    - `report_path`: Caminho para o relat√≥rio HTML principal (`resumo_geral.html`).
    - `json_summary_path`: **Crucial para a an√°lise de tend√™ncia.** Caminho para o arquivo `resumo_problemas.json` daquela an√°lise.
    - `date_range`: (Opcional) String que armazena o intervalo de datas coberto pelo relat√≥rio (ex: "01/01/2023 a 15/01/2023").
    - `max_date`: (Opcional) **Novo campo fundamental.** Armazena o objeto de data correspondente √† data mais recente do *conte√∫do* do arquivo de input.
- **Responsabilidade:** Manter um hist√≥rico de todas as an√°lises executadas. A compara√ß√£o para an√°lise de tend√™ncia agora √© mais inteligente: em vez de apenas pegar a √∫ltima an√°lise executada, o sistema usa o campo `max_date` para encontrar a an√°lise anterior mais relevante cujo conte√∫do seja cronologicamente anterior ao do upload atual.

## 4. Agente de Intelig√™ncia Artificial (`src/ai_agent.py`)
- **Responsabilidade:** Fornecer uma interface de linguagem natural para interagir com os dados e a documenta√ß√£o.
- **Capacidades Principais:**
    - **Assistente de Chat (Reativo):** Atrav√©s da rota `/chat/ask`, o agente responde a perguntas do usu√°rio sobre os dados de um relat√≥rio espec√≠fico ou sobre a documenta√ß√£o do projeto, usando um sistema de ferramentas (`project_docs_tool`, `data_analysis_tool`).
    - **Gerador de Resumo (Proativo):** Durante o processamento da an√°lise, o agente √© invocado para gerar um resumo executivo. Ele possui duas l√≥gicas distintas:
        - `gerar_resumo_ia`: Cria um resumo comparativo quando h√° uma an√°lise de tend√™ncia.
        - `gerar_resumo_analise_unica_ia`: Cria um resumo focado nos pontos cr√≠ticos quando √© uma an√°lise √∫nica.
- **Controle de Ativa√ß√£o:** A funcionalidade de IA pode ser globalmente desativada pela vari√°vel de ambiente `AI_AGENT_ENABLED="false"`. Al√©m disso, a gera√ß√£o de resumo para cada an√°lise pode ser controlada pelo usu√°rio atrav√©s de um interruptor na interface de upload.

## 5. Motores de An√°lise (Invocados como Bibliotecas)

#### M√≥dulo: `src/analisar_alertas.py`
- **Responsabilidade:** Processar um √∫nico arquivo de alertas, realizar a an√°lise principal e orquestrar a gera√ß√£o dos relat√≥rios HTML para aquele per√≠odo.
- **Invoca√ß√£o:** √â chamado como uma fun√ß√£o Python diretamente do `app.py`.
- **Entradas (Inputs):** Recebe o caminho do arquivo de input e o diret√≥rio de output como argumentos de fun√ß√£o. A flag `light_analysis` controla a profundidade da an√°lise.
- **Sa√≠das (Outputs):** Retorna um dicion√°rio contendo os caminhos para os artefatos gerados (HTML e JSON).

#### M√≥dulo: `src/analise_tendencia.py`
- **Responsabilidade:** Comparar dois per√≠odos (JSON atual vs. JSON anterior) e gerar o `resumo_tendencia.html`.
- **Invoca√ß√£o:** √â chamado como uma fun√ß√£o Python diretamente do `app.py`.
- **Entradas (Inputs):** Recebe os caminhos para os dois arquivos JSON (`json_anterior`, `json_atual`) e os nomes dos arquivos CSV originais como argumentos de fun√ß√£o.

## 4. Templates e Dados

- **`templates/`:** Cont√©m todos os templates HTML usados pelo Flask para renderizar as p√°ginas da aplica√ß√£o (`upload.html`, `status.html`, `relatorios.html`, etc.).
- **`data/`:** Diret√≥rio persistido que armazena:
    - `uploads/`: C√≥pias dos arquivos `.csv` originais enviados pelo usu√°rio.
    - `reports/`: Subdiret√≥rios para cada execu√ß√£o (`run_...`), contendo todos os artefatos gerados (HTML, JSON, CSV).
    - `meu_dash.db`: O arquivo do banco de dados SQLite.

---

# üåä FLUXO DE EXECU√á√ÉO L√ìGICO (ASS√çNCRONO)

O processo √© iniciado pela intera√ß√£o do usu√°rio, mas a an√°lise pesada √© executada em segundo plano pelo Celery.
1.  **Usu√°rio:** Acessa a rota `/` e v√™ a p√°gina de upload.
2.  **Upload:** O usu√°rio seleciona um arquivo `.csv` (`file_atual`), decide se quer o resumo da IA atrav√©s de um interruptor na tela, e envia o formul√°rio (`POST /upload`).
3.  **Disparo da Tarefa (`app.py`):**
    a. O `app.py` salva o arquivo em `data/uploads/`.
    b. A tarefa `processar_analise.delay()` √© chamada, passando os caminhos necess√°rios e a decis√£o do usu√°rio sobre usar a IA (`use_ai_agent`). Isso enfileira a tarefa no Celery.
    c. O `app.py` retorna imediatamente um `task_id` para o frontend, que redireciona o usu√°rio para a p√°gina de status (`/task/<task_id>`).
4.  **Execu√ß√£o da Tarefa em Background (Worker Celery):**
    a. **Valida√ß√£o:** A tarefa `processar_analise` inicia, extrai as datas do arquivo e valida a cronologia em rela√ß√£o ao √∫ltimo relat√≥rio no banco de dados.
    b. **An√°lise de Tend√™ncia:** Se um relat√≥rio anterior existe, uma an√°lise de tend√™ncia √© executada.
    c. **An√°lise Principal:** A an√°lise completa do arquivo atual √© executada.
    d. **Gera√ß√£o de Resumo por IA (Condicional):** Se `use_ai_agent` for verdadeiro, o agente de IA √© chamado para gerar um resumo executivo (de tend√™ncia ou de an√°lise √∫nica).
    e. **Persist√™ncia:** Um novo registro `Report` √© salvo no banco de dados.
    f. **Rota√ß√£o:** A tarefa verifica se o n√∫mero de relat√≥rios excede o limite (`MAX_REPORTS`) e remove os diret√≥rios e registros do banco de dados dos relat√≥rios mais antigos.
5.  **Feedback ao Usu√°rio:** A p√°gina de status consulta periodicamente o endpoint `/status/<task_id>`. Quando a tarefa √© conclu√≠da com sucesso, o frontend recebe a URL do novo relat√≥rio e o resumo da IA (se houver), e redireciona o usu√°rio para a p√°gina inicial, onde um card com o resumo √© exibido. Em caso de falha, exibe a mensagem de erro.

---

# üì¶ ARTEFATOS GERADOS (OUTPUTS)

Todos os artefatos s√£o gerados dentro de um subdiret√≥rio `run_<timestamp>` em `data/reports/` e servidos dinamicamente pela aplica√ß√£o Flask.

## Dashboards HTML Interativos
- **`resumo_geral.html`**: Vis√£o geral gerencial do per√≠odo atual. Ponto central de navega√ß√£o.
- **`resumo_tendencia.html`**: (Condicional) Relat√≥rio de evolu√ß√£o entre o per√≠odo atual e o anterior.
- **`editor_atuacao.html`**: Editor interativo para o time atuar sobre os problemas.
- ... (e todos os outros relat√≥rios)

## Arquivos de Dados
- **`resumo_problemas.json`**: A base de dados da an√°lise, usada para gerar relat√≥rios e para a pr√≥xima an√°lise de tend√™ncia.
- **`atuar.csv`**: Lista de problemas que exigem a√ß√£o manual.
- ... (e todos os outros arquivos de dados)

---

# üéØ MELHORIAS FUTURAS E PONTOS DE ATEN√á√ÉO

- **Precis√£o do Agente de IA:** Embora funcional, o agente de IA que gera os resumos executivos ainda precisa de refinamento. Os resultados atuais, por vezes, carecem de precis√£o nos valores e na identifica√ß√£o dos temas mais relevantes. √â necess√°rio iterar nos prompts e, possivelmente, na forma como os dados de contexto s√£o fornecidos para melhorar a qualidade e a confiabilidade dos insights gerados para a gest√£o.